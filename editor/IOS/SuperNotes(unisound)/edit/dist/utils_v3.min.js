/*! utils_v3 12-09-2014 */
var editor=window.editor={};!function(a){a.init=function(b,c){a.doc=document,a.options={id:b,node:a.doc.querySelector("#"+b),timenode:a.doc.querySelector("#"+c),json:{},keys:{},newkeys:[],bookmark:null,textNodes:{},top:0,width:210,lineheight:0,indentcount:3,keyBoradIsShow:!1,language:"zh-cn",isdefault:!1,isNew:!0,isLoaded:!1,mrgalign:function(){return parseInt(getComputedStyle(this.node,!1)["padding-left"])},cmds:["Bold","Italic","Underline","InsertOrderedList","InsertUnorderedList","JustifyLeft","JustifyCenter","JustifyRight","Undo","Redo"]}}}(editor),function(a){a.api={setHeight:function(b){a.options.height=b,a.options.node.style.cssText+="min-height:"+b+"px"},adjustTop:function(b,c){function d(a){return Math.pow(a,2)}if(a.options.top=b,!c)return void(a.options.node.style["margin-top"]=b+"px");var e=a.options.node.offsetTop,f=300,g=(new Date).getTime(),h=setInterval(function(){var c=(new Date).getTime(),i=c-g,j=d(i/f),k=j*(b-e);i>=f?(a.options.node.style["margin-top"]=b+"px",clearInterval(h)):a.options.node.style["margin-top"]=Math.ceil(e+k)+"px"},10)},getSummary:function(b){{var c,d,e="";document.createElement("div")}if(a.controls.hasContent()){if(c=a.options.node.querySelectorAll("div[key]"),c.length)for(d=0;d<(c.length>3?3:c.length);d++)e+=c[d].innerText+"\\n";else e=a.options.node.innerText,e=e?e.substring(0,b?b:1024):"";return e}},getTextNode:function(){return a.utils.parseString(a.options.textNodes)},getAllKeys:function(){for(var b=a.options.node.querySelectorAll("[key]"),c=[],d=0;d<b.length;d++){var e=b[d];c.push(e.getAttribute("key"))}return c.join(",")},keyBoardStatuses:function(b){a.options.keyBoradIsShow=b,b||a.options.node.setAttribute("contenteditable","false")},resetPhoto:function(b,c,d){var e=a.options.node.querySelector('[key="'+b+'"]');e&&(e.setAttribute("src",c),a.controls.setImgWidth(e,d))},isDefaultNote:function(b){a.options.isdefault=b},setLanguage:function(b){return!b||/[\u4E00-\u9FA5]/g.test(b)?void(a.options.language="zh-cn"):void(/[a-zA-Z]/g.test(b)&&(a.options.language="en-us"))},isLoaded:function(){return a.options.isLoaded}}}(editor),function(a){a.cmd=function(b,c){var d,e=b.toLowerCase(),f=a.controls.getRange(),g=f.startContainer,h=f.endContainer;if("indent"==e){for(d=0;g.parentNode;)("BLOCKQUOTE"==g.parentNode.tagName||"OL"==g.parentNode.tagName||"UL"==g.parentNode.tagName)&&d++,g=g.parentNode;if(d>=a.options.indentcount)return}return"insertorderedlist"!=e&&"insertunorderedlist"!=e||!g.parentNode.getAttribute("key")&&!h.parentNode.getAttribute("key")?(a.doc.execCommand(b,!1,c||!1),a.extendEvent.fireEvent("adjustimages"),void a.extendEvent.fireEvent("selChange")):!1}}(editor),function(a){a.controls={toDom:function(b){var c=a.doc.createElement("div");return c.innerHTML=b,c},setParse:function(b){var c,d=b.tagName.toLowerCase().match(/[^-]+$/)[0],e=b.getAttribute("key"),f=a.doc.createElement("text"==d?"div":"img"),g=a.options.json[e],h=b.getAttribute("_data");return"DIV"==f.tagName?(h&&(c=a.doc.createElement("div"),c.innerHTML="<div "+Base64.decode(h)+"></div>",f=c.firstChild),f.innerHTML=a.options.json[e].fName):(f.src=a.options.json[e].fUrl,this.setImgWidth(f,g.width)),a.utils.setAttrs(f,{type:d,key:e}),f},getParse:function(b){var c=b.getAttribute("type"),d=b.getAttribute("key"),e=b.getAttribute("style"),f=a.doc.createElement("ln-"+c),g="";return"text"==c&&(e&&(g+='style="'+e+'" '),g.length>0&&f.setAttribute("_data",Base64.encode(g))),f.setAttribute("key",d),f},setContent:function(b,c,d,e){function f(){for(var b=a.options.node.querySelectorAll("img"),c=0;c<b.length;c++){var d=b[c],e=a.utils.getOffset(d,"Left")-a.options.mrgalign(),f=d.offsetWidth,g=a.options.width-2*a.options.mrgalign(),h=d.getAttribute("maxw");(e+f>g||g>e+f&&h>f)&&d.setAttribute("width",g-e)}}if(b=a.utils.filterXSS(b),a.options.isLoaded=!1,a.options.keyBoradIsShow=!1,a.options.width=c||210,a.extendEvent.addEvent("adjustimages",f),!b||/^\s*$/g.test(b))return a.options.node.innerText=a.I18N[a.options.language].writesometing,void(a.options.isLoaded=!0);d=a.utils.isString(d)?a.utils.parseJSON(d):d,a.options.json=d||{};for(var g=this.toDom(b),h=g.querySelectorAll("[key]"),i=0;i<h.length;i++){var j=h[i],k=j.parentNode;a.options.keys[j.getAttribute("key")]=1,k.replaceChild(this.setParse(j),j)}a.doc.querySelector("body").style.cssText+="width:"+a.options.width+"px;",a.options.node.innerHTML=g.innerHTML,e&&(a.options.isNew=!1,a.options.timenode.classList.add("show"),a.options.timenode.innerText=a.I18N[a.options.language].createBy+e),a.extendEvent.fireEvent("adjustimages"),a.options.isLoaded=!0},getContent:function(){var b,c,d;if(this.hasContent()){this.cancelBookmark(),a.options.textNodes={},b=a.options.node.innerHTML,c=this.toDom(b),d=c.querySelectorAll("[key]");for(var e=0;e<d.length;e++){var f=d[e],g=f.getAttribute("key"),h=f.parentNode;if("DIV"==f.tagName){if(/^\s*(<br\/?>)?\s*$/gi.test(f.innerHTML)){var i=a.options.node.querySelector('[key="'+g+'"]');i.parentNode.removeChild(i),f.parentNode.removeChild(f);continue}a.options.textNodes[f.getAttribute("key")]=f.innerHTML}h.replaceChild(this.getParse(f),f),a.options.keys[g]&&2!=a.options.keys[g]||a.options.newkeys.push(g),a.options.keys[g]=2}return a.utils.filterXSS(c.innerHTML.replace(/<br>/gi,"<br/>"))}},insertFile:function(b){this.hasContent()||(a.options.node.innerText="");var c,d=this.getBookmark();if(b=a.utils.isString(b)?a.utils.parseJSON(b):b,"text"==b.type)c=a.doc.createElement("div"),c.innerHTML=b.fName;else{var e=a.options.width-2*a.options.mrgalign();c=a.doc.createElement("img"),c.setAttribute("src",b.fUrl),c.setAttribute("width",b.width>e?e:b.width)}a.utils.setAttrs(c,{type:b.type,key:b.key}),a.options.keys[b.key]=1,d&&d.parentNode?d.parentNode.insertBefore(c,d):a.options.node.appendChild(c),this.cancelBookmark(d)},createBookmark:function(){var b=this.getRange();if(b.customer)return this.getBookmark();var c=a.doc.createElement("span");return c.setAttribute("id","leNote_bookMark"),this.cancelBookmark(),b.insertNode(c),a.options.bookmark=c,c},cancelBookmark:function(b){var b=b?b:this.getBookmark();b&&b.parentNode&&(b.parentNode.removeChild(b),a.options.bookmark=null)},getBookmark:function(){return a.options.bookmark||a.options.node.querySelector("#leNote_bookMark")},getRange:function(){var b,c=getSelection();if(c&&c.rangeCount)b=c.getRangeAt(0);else{b=a.doc.createRange();var d=a.options.node.firstChild;for(d||b.setStart(a.options.node,0);d;)b.setStart(d,0),d=d.firstChild;b.customer=1}return b},select:function(a){var b=getSelection();b.removeAllRanges(),b.addRange(a)},findPre:function(a){for(;a&&a;){if(a.tagName&&a.hasAttribute("key"))return a;a=a.previousSibling}},adjustCaret:function(a,b){var c=this.getRange();b?(c.setStartAfter(a),c.collapse(!0)):(c.setEndBefore(a),c.collapse(!1)),this.select(c)},getPointformRange:function(){var b=this.getRange(),c=a.doc.createElement("span"),d=0,e=0,f=null;for(b.insertNode(c),f=c;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;return f.parentNode.removeChild(f),{x:d,y:e}},inView:function(){var b=null,c=null,d=this.getPointformRange().y,e=a.options.height||240,f=a.doc.body.scrollTop,g=a.options.top||80,h=a.options.lineheight||(a.options.lineheight=parseInt(a.utils.getStyle(a.options.node,"lineHeight")));return c=d,f-=g,d-=g,f&&(b="middle"),h>d-f&&(b="top"),d+h-(e+f)>0&&(b="bottom"),{position:b,y:c}},setImgWidth:function(b,c){var d=a.options.width-2*a.options.mrgalign();c=parseInt(c),b.setAttribute("width",c>d?d:c)},hasContent:function(){return a.options.node.innerText!=a.I18N[a.options.language].writesometing}}}(editor),function(a){a.extendEvent={fireEvent:function(b){for(var c=a.extendEvent.events[b]||[],d=0;d<c.length;d++){var e=c[d];e.apply(this,arguments)}},addEvent:function(b,c){"undefined"==typeof a.extendEvent.events&&(a.extendEvent.events={});var d=a.extendEvent.events[b]||(d=a.extendEvent.events[b]=[]);d.push(c)}}}(editor),function(a){a.listener=function(){function b(){for(var b={},c=0;c<a.options.cmds.length;c++){var d=a.options.cmds[c];b[d]=a.doc.queryCommandState(d)}a.doc.location.href="http://500?"+a.utils.parseString(b)}function c(){var b=a.controls.inView();"top"==b.position&&window.scrollTo(0,b.y-10),"bottom"==b.position&&window.scrollTo(0,b.y-a.options.height+a.options.lineheight)}var d,e=a.options;a.extendEvent.addEvent("selChange",b),a.doc.addEventListener("selectionchange",function(){a.utils.throttle(b)}),e.node.addEventListener("focus",function(){a.controls.hasContent()||(e.node.innerText=""),e.node.classList.add("active"),e.timenode.classList.remove("show")}),e.node.addEventListener("blur",function(){var b=e.bookmark?e.node.innerHTML.replace(e.bookmark.outerHTML,""):e.node.innerHTML;b=b.replace(/<div>/,"").replace(/<br\/?>/,"").replace(/<\/div>/,""),b||(e.node.innerText=a.I18N[a.options.language].writesometing,e.node.classList.remove("active")),a.options.isNew||e.timenode.classList.add("show")}),Hammer(e.node,{behavior:{userSelect:!0}}).on("tap",function(b){var c=b.target,e=b.gesture.center.pageX,f=b.gesture.center.pageY;if("IMG"==c.tagName)a.options.keyBoradIsShow?a.controls.adjustCaret(c,e-c.offsetLeft>c.offsetWidth/2):a.doc.location.href="http://400?"+c.getAttribute("key");else if(!a.options.keyBoradIsShow){if(a.options.isdefault)return;if("A"==c.tagName)return void(a.doc.location.href=c.getAttribute("href"));a.options.node.setAttribute("contenteditable","true"),d=a.doc.caretRangeFromPoint(e,f),a.controls.select(d)}}),e.node.addEventListener("keyup",function(b){if(13==b.keyCode){var d=a.controls.getRange(),e=d.startContainer;e=3==e.nodeType?e.parentNode:e,"DIV"==e.tagName&&e.getAttribute("key")&&e.getAttribute("type")&&(e.removeAttribute("key"),e.removeAttribute("type"))}c()}),e.node.addEventListener("keydown",function(b){if(8==b.keyCode){{e.node}if(d=a.controls.getRange(),d.collapsed&&(3==d.startContainer.nodeType&&0==d.startOffset||1==d.startContainer.nodeType)){var c=a.controls.createBookmark(),f=a.controls.findPre(c);f&&f.tagName&&f.hasAttribute("key")&&!a.utils.inSelection(f)&&(d.selectNode(f),a.controls.select(d),b.preventDefault()),a.controls.cancelBookmark()}}})}}(editor),function(a){a.utils={setAttrs:function(a,b){for(var c in b)a.setAttribute(c,b[c])},parseJSON:function(a){return JSON.parse(a)},parseString:function(a){return JSON.stringify(a)},isString:function(a){return"string"==typeof a},getStyle:function(a,b){return getComputedStyle(a,!1)[b]},inSelection:function(b){var c=a.controls.getRange(),d=c.cloneContents();return d.querySelector('[key="'+b.getAttribute("key")+'"]')},throttle:function(a,b){clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},100)},getOffset:function(a,b){for(var b="offset"+b,c=a[b];a=a.offsetParent;)c+=a[b];return c},extend:function(){var a,b=arguments[0],c=1;for(1===arguments.length&&(b=this,c=0);a=arguments[c++];)for(var d in a)b[d]=a[d];return b},filterXSS:function(a){return filterXSS(a,{allowCommentTag:!1,whiteList:this.extend(filterXSS.whiteList,{"ln-photo":["key","_data"],"ln-attachment":["key"],"ln-audio":["key"],"ln-text":["key","_data"],"ln-video":["key"]}),onIgnoreTagAttr:function(a,b,c){return"style"===b?(c=filterXSS.safeAttrValue(a,b,c),c?b+'="'+c+'"':b):void 0}})}}}(editor);